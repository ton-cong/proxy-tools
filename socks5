#!/bin/bash

# SOCKS5 Proxy Manager cho Amazon Linux 2023/2
# Hỗ trợ: Cài đặt, Thêm user, Xóa user, Xóa hoàn toàn
# GitHub: https://github.com/yourusername/socks5-amazonlinux

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

DANTE_CONFIG="/etc/danted.conf"
DANTE_SERVICE="/etc/systemd/system/danted.service"
DANTE_BIN="/usr/local/sbin/sockd"

# Hàm kiểm tra quyền root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Script này cần chạy với quyền root (sudo)${NC}"
        exit 1
    fi
}

# Hàm lấy IP public
get_public_ip() {
    curl -s ifconfig.me || curl -s icanhazip.com || echo "Unknown"
}

# Hàm lấy interface network
get_network_interface() {
    ip -o -4 route show to default | awk '{print $5}' | head -n1
}

# Hàm cài đặt Dante từ source
install_dante() {
    echo -e "${YELLOW}Đang cài đặt dependencies...${NC}"
    yum install -y gcc make wget tar shadow-utils >/dev/null 2>&1
    
    echo -e "${YELLOW}Đang tải và build Dante Server...${NC}"
    cd /tmp
    if [ ! -f "dante-1.4.3.tar.gz" ]; then
        wget -q https://www.inet.no/dante/files/dante-1.4.3.tar.gz
    fi
    
    tar xzf dante-1.4.3.tar.gz >/dev/null 2>&1
    cd dante-1.4.3
    
    ./configure >/dev/null 2>&1
    make >/dev/null 2>&1
    make install >/dev/null 2>&1
    
    cd /tmp
    rm -rf dante-1.4.3*
    
    echo -e "${GREEN}✓ Dante Server đã được cài đặt${NC}"
}

# Hàm tạo cấu hình Dante
create_dante_config() {
    local port=$1
    local interface=$(get_network_interface)
    
    cat > $DANTE_CONFIG <<EOF
logoutput: /var/log/danted.log
internal: 0.0.0.0 port = $port
external: $interface

method: username
user.notprivileged: nobody

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect
}

pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    protocol: tcp udp
    method: username
    log: connect disconnect
}
EOF
    
    echo -e "${GREEN}✓ Đã tạo file cấu hình${NC}"
}

# Hàm tạo systemd service
create_systemd_service() {
    cat > $DANTE_SERVICE <<EOF
[Unit]
Description=Dante SOCKS5 Server
After=network.target

[Service]
ExecStart=$DANTE_BIN -f $DANTE_CONFIG
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable danted >/dev/null 2>&1
    echo -e "${GREEN}✓ Đã tạo systemd service${NC}"
}

# Hàm cài đặt SOCKS5
install_socks5() {
    echo -e "${GREEN}=== CÀI ĐẶT SOCKS5 PROXY ===${NC}\n"
    
    # Nhập thông tin
    read -p "Nhập PORT (mặc định 1080): " port
    port=${port:-1080}
    
    read -p "Nhập USERNAME: " username
    while [ -z "$username" ]; do
        echo -e "${RED}Username không được để trống!${NC}"
        read -p "Nhập USERNAME: " username
    done
    
    read -sp "Nhập PASSWORD: " password
    echo
    while [ -z "$password" ]; do
        echo -e "${RED}Password không được để trống!${NC}"
        read -sp "Nhập PASSWORD: " password
        echo
    done
    
    # Cài đặt Dante nếu chưa có
    if [ ! -f "$DANTE_BIN" ]; then
        install_dante
    fi
    
    # Tạo user
    useradd -M -s /sbin/nologin $username 2>/dev/null || true
    echo "$username:$password" | chpasswd
    echo -e "${GREEN}✓ Đã tạo user: $username${NC}"
    
    # Tạo cấu hình
    create_dante_config $port
    
    # Tạo service
    create_systemd_service
    
    # Khởi động dịch vụ
    systemctl restart danted
    sleep 2
    
    # Hiển thị thông tin
    local ip=$(get_public_ip)
    
    echo -e "\n${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║   SOCKS5 PROXY ĐÃ CÀI ĐẶT THÀNH CÔNG  ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}\n"
    echo -e "🔌 ${YELLOW}IP:${NC}       $ip"
    echo -e "🔐 ${YELLOW}Port:${NC}     $port"
    echo -e "👤 ${YELLOW}Username:${NC} $username"
    echo -e "🔑 ${YELLOW}Password:${NC} $password"
    echo -e "\n${GREEN}Cú pháp sử dụng:${NC}"
    echo -e "socks5://$username:$password@$ip:$port"
    echo -e "\n${GREEN}Test proxy:${NC}"
    echo -e "curl -x socks5h://$username:$password@$ip:$port https://ifconfig.me\n"
}

# Hàm thêm user mới
add_user() {
    echo -e "${GREEN}=== THÊM USER MỚI ===${NC}\n"
    
    if [ ! -f "$DANTE_BIN" ]; then
        echo -e "${RED}SOCKS5 chưa được cài đặt! Vui lòng cài đặt trước.${NC}"
        exit 1
    fi
    
    read -p "Nhập USERNAME mới: " username
    while [ -z "$username" ]; do
        echo -e "${RED}Username không được để trống!${NC}"
        read -p "Nhập USERNAME mới: " username
    done
    
    # Kiểm tra user đã tồn tại
    if id "$username" &>/dev/null; then
        echo -e "${YELLOW}User $username đã tồn tại!${NC}"
        read -p "Bạn có muốn đổi mật khẩu? (y/n): " change_pass
        if [ "$change_pass" != "y" ]; then
            return
        fi
    fi
    
    read -sp "Nhập PASSWORD: " password
    echo
    while [ -z "$password" ]; do
        echo -e "${RED}Password không được để trống!${NC}"
        read -sp "Nhập PASSWORD: " password
        echo
    done
    
    # Tạo hoặc cập nhật user
    useradd -M -s /sbin/nologin $username 2>/dev/null || true
    echo "$username:$password" | chpasswd
    
    # Lấy thông tin
    local ip=$(get_public_ip)
    local port=$(grep "port =" $DANTE_CONFIG | awk '{print $4}')
    
    systemctl restart danted
    
    echo -e "\n${GREEN}✓ User đã được thêm/cập nhật thành công!${NC}\n"
    echo -e "🔌 ${YELLOW}IP:${NC}       $ip"
    echo -e "🔐 ${YELLOW}Port:${NC}     $port"
    echo -e "👤 ${YELLOW}Username:${NC} $username"
    echo -e "🔑 ${YELLOW}Password:${NC} $password"
    echo -e "\n${GREEN}Cú pháp:${NC} socks5://$username:$password@$ip:$port\n"
}

# Hàm liệt kê users
list_users() {
    echo -e "${GREEN}=== DANH SÁCH USERS ===${NC}\n"
    
    if [ ! -f "$DANTE_CONFIG" ]; then
        echo -e "${RED}SOCKS5 chưa được cài đặt!${NC}"
        return
    fi
    
    local ip=$(get_public_ip)
    local port=$(grep "port =" $DANTE_CONFIG 2>/dev/null | awk '{print $4}')
    
    echo -e "${YELLOW}Server:${NC} $ip:$port\n"
    echo -e "${YELLOW}Users (có thể dùng cho SOCKS5):${NC}"
    
    # Lấy danh sách users có shell /sbin/nologin (users cho proxy)
    awk -F: '$7 == "/sbin/nologin" {print "  • " $1}' /etc/passwd
    echo
}

# Hàm xóa user
delete_user() {
    echo -e "${GREEN}=== XÓA USER ===${NC}\n"
    
    list_users
    
    read -p "Nhập username cần xóa: " username
    
    if [ -z "$username" ]; then
        echo -e "${RED}Username không được để trống!${NC}"
        return
    fi
    
    if ! id "$username" &>/dev/null; then
        echo -e "${RED}User $username không tồn tại!${NC}"
        return
    fi
    
    read -p "Bạn có chắc muốn xóa user $username? (y/n): " confirm
    if [ "$confirm" = "y" ]; then
        userdel $username 2>/dev/null
        echo -e "${GREEN}✓ Đã xóa user: $username${NC}"
        systemctl restart danted
    else
        echo -e "${YELLOW}Hủy bỏ thao tác${NC}"
    fi
}

# Hàm xóa hoàn toàn SOCKS5
uninstall_socks5() {
    echo -e "${RED}=== XÓA HOÀN TOÀN SOCKS5 ===${NC}\n"
    
    read -p "⚠️  Bạn có CHẮC CHẮN muốn xóa toàn bộ SOCKS5? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        echo -e "${YELLOW}Hủy bỏ thao tác${NC}"
        return
    fi
    
    echo -e "${YELLOW}Đang xóa...${NC}"
    
    # Dừng service
    systemctl stop danted 2>/dev/null
    systemctl disable danted 2>/dev/null
    
    # Xóa files
    rm -f $DANTE_SERVICE
    rm -f $DANTE_CONFIG
    rm -f /var/log/danted.log
    rm -f $DANTE_BIN
    rm -rf /usr/local/sbin/sockd
    rm -rf /usr/local/lib/libdsocks*
    
    # Xóa users proxy (có shell /sbin/nologin)
    awk -F: '$7 == "/sbin/nologin" {print $1}' /etc/passwd | while read user; do
        userdel $user 2>/dev/null
    done
    
    systemctl daemon-reload
    
    echo -e "${GREEN}✓ Đã xóa hoàn toàn SOCKS5 Proxy${NC}\n"
}

# Hàm hiển thị trạng thái
show_status() {
    echo -e "${GREEN}=== TRẠNG THÁI SOCKS5 ===${NC}\n"
    
    if [ ! -f "$DANTE_BIN" ]; then
        echo -e "${RED}SOCKS5 chưa được cài đặt!${NC}"
        return
    fi
    
    local ip=$(get_public_ip)
    local port=$(grep "port =" $DANTE_CONFIG 2>/dev/null | awk '{print $4}')
    
    echo -e "🔌 ${YELLOW}IP:${NC}   $ip"
    echo -e "🔐 ${YELLOW}Port:${NC} $port\n"
    
    if systemctl is-active --quiet danted; then
        echo -e "📊 ${GREEN}Service: RUNNING ✓${NC}"
    else
        echo -e "📊 ${RED}Service: STOPPED ✗${NC}"
    fi
    
    echo -e "\n${YELLOW}Số lượng users:${NC}"
    awk -F: '$7 == "/sbin/nologin" {print "  • " $1}' /etc/passwd
    
    echo -e "\n${YELLOW}Kiểm tra port:${NC}"
    if netstat -tuln 2>/dev/null | grep -q ":$port "; then
        echo -e "  ${GREEN}✓ Port $port đang mở${NC}"
    else
        echo -e "  ${RED}✗ Port $port không mở${NC}"
    fi
    echo
}

# Menu chính
show_menu() {
    clear
    echo -e "${GREEN}╔════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║     SOCKS5 PROXY - AMAZON LINUX       ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════╝${NC}\n"
    echo "1. Cài đặt SOCKS5 Proxy"
    echo "2. Thêm user mới"
    echo "3. Liệt kê users"
    echo "4. Xóa user"
    echo "5. Xem trạng thái"
    echo "6. Xóa hoàn toàn SOCKS5"
    echo "0. Thoát"
    echo -e "\n${YELLOW}Chọn chức năng [0-6]:${NC} "
}

# Hàm cài đặt lần đầu (không menu)
first_install() {
    echo -e "${GREEN}=== CÀI ĐẶT SOCKS5 PROXY LẦN ĐẦU ===${NC}\n"
    
    # Nhập PORT
    read -p "Nhập PORT (mặc định 1080): " port
    port=${port:-1080}
    
    # Nhập USERNAME
    read -p "Nhập USERNAME: " username
    while [ -z "$username" ]; do
        echo -e "${RED}Username không được để trống!${NC}"
        read -p "Nhập USERNAME: " username
    done
    
    # Nhập PASSWORD
    read -sp "Nhập PASSWORD: " password
    echo
    while [ -z "$password" ]; do
        echo -e "${RED}Password không được để trống!${NC}"
        read -sp "Nhập PASSWORD: " password
        echo
    done
    
    # Cài đặt Dante
    install_dante
    
    # Tạo user
    useradd -M -s /sbin/nologin $username 2>/dev/null || true
    echo "$username:$password" | chpasswd
    echo -e "${GREEN}✓ Đã tạo user: $username${NC}"
    
    # Tạo cấu hình
    create_dante_config $port
    
    # Tạo service
    create_systemd_service
    
    # Khởi động dịch vụ
    systemctl restart danted
    sleep 2
    
    # Hiển thị thông tin
    local ip=$(get_public_ip)
    
    echo -e "\n${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║   SOCKS5 PROXY ĐÃ CÀI ĐẶT THÀNH CÔNG  ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}\n"
    echo -e "🔌 ${YELLOW}IP:${NC}       $ip"
    echo -e "🔐 ${YELLOW}Port:${NC}     $port"
    echo -e "👤 ${YELLOW}Username:${NC} $username"
    echo -e "🔑 ${YELLOW}Password:${NC} $password"
    echo -e "\n${GREEN}Cú pháp sử dụng:${NC}"
    echo -e "socks5://$username:$password@$ip:$port"
    echo -e "\n${GREEN}Test proxy:${NC}"
    echo -e "curl -x socks5h://$username:$password@$ip:$port https://ifconfig.me\n"
    
    exit 0
}

# Hàm main
main() {
    check_root
    
    # Kiểm tra xem đã cài SOCKS5 chưa
    if [ ! -f "$DANTE_BIN" ]; then
        # Chưa cài - Kiểm tra xem có input tự động không
        if [ -p /dev/stdin ]; then
            read -t 0.1 port username password 2>/dev/null || true
            if [ -n "$port" ] && [ -n "$username" ] && [ -n "$password" ]; then
                # Cài đặt tự động
                install_dante
                
                useradd -M -s /sbin/nologin $username 2>/dev/null || true
                echo "$username:$password" | chpasswd
                
                create_dante_config $port
                create_systemd_service
                systemctl restart danted
                
                local ip=$(get_public_ip)
                echo -e "\n${GREEN}✓ SOCKS5 đã cài đặt: socks5://$username:$password@$ip:$port${NC}\n"
                exit 0
            fi
        fi
        
        # Cài đặt lần đầu với input thủ công
        first_install
    else
        # Đã cài rồi - Hiển thị menu
        while true; do
            show_menu
            read -r choice
            
            case $choice in
                1) install_socks5 ;;
                2) add_user ;;
                3) list_users ;;
                4) delete_user ;;
                5) show_status ;;
                6) uninstall_socks5 ;;
                0) echo -e "${GREEN}Tạm biệt!${NC}"; exit 0 ;;
                *) echo -e "${RED}Lựa chọn không hợp lệ!${NC}" ;;
            esac
            
            echo -e "\n${YELLOW}Nhấn Enter để tiếp tục...${NC}"
            read
        done
    fi
}

# Chạy script
main
