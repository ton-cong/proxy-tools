#!/bin/bash
# ==============================================
# SOCKS5 Proxy (Dante) Installer & Manager
# For Amazon Linux 2023 / Amazon Linux 2
# Author: <your_github_username>
# Repo: https://github.com/<your_github_username>/socks5-amazonlinux
# ==============================================

set -e

# -----------------------------
# ‚öôÔ∏è  C√†i ƒë·∫∑t proxy
# -----------------------------
install_proxy() {
    PORT=1080
    USER=proxyuser
    PASS=proxy123

    echo "üîß ƒêang c√†i ƒë·∫∑t SOCKS5 Proxy (Dante)..."

    # C√†i ƒë·∫∑t g√≥i c·∫ßn thi·∫øt
    sudo yum install -y gcc make wget tar shadow-utils > /dev/null 2>&1

    # T·∫°o user proxy
    sudo useradd -M -s /sbin/nologin $USER 2>/dev/null || true
    echo "$USER:$PASS" | sudo chpasswd

    # T·∫£i v√† build Dante
    cd /tmp
    wget -q https://www.inet.no/dante/files/dante-1.4.3.tar.gz
    tar xzf dante-1.4.3.tar.gz
    cd dante-1.4.3
    ./configure > /dev/null && make > /dev/null && sudo make install > /dev/null

    # L·∫•y interface m·∫°ng th·∫≠t
    NET_IF=$(ip route get 8.8.8.8 | awk '{print $5; exit}')

    # C·∫•u h√¨nh Dante
    sudo tee /etc/danted.conf > /dev/null <<EOF
logoutput: /var/log/danted.log
internal: 0.0.0.0 port = $PORT
external: $NET_IF

method: username
user.notprivileged: nobody

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect
}

pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    protocol: tcp udp
    method: username
    log: connect disconnect
}
EOF

    # T·∫°o service
    sudo tee /etc/systemd/system/danted.service > /dev/null <<EOF
[Unit]
Description=Dante SOCKS5 Server
After=network.target

[Service]
ExecStart=/usr/local/sbin/sockd -f /etc/danted.conf
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    # Kh·ªüi ƒë·ªông d·ªãch v·ª•
    sudo systemctl daemon-reload
    sudo systemctl enable danted > /dev/null
    sudo systemctl restart danted

    IP=$(curl -s ifconfig.me)
    echo ""
    echo "‚úÖ SOCKS5 proxy ƒë√£ c√†i v√† kh·ªüi ƒë·ªông!"
    echo "üîå IP: $IP"
    echo "üîê Port: $PORT"
    echo "üë§ User: $USER"
    echo "üîë Pass: $PASS"
}

# -----------------------------
# üë§ Th√™m user m·ªõi
# -----------------------------
add_user() {
    read -p "Nh·∫≠p username m·ªõi: " USER
    read -s -p "Nh·∫≠p password: " PASS
    echo
    sudo useradd -M -s /sbin/nologin $USER 2>/dev/null || true
    echo "$USER:$PASS" | sudo chpasswd
    echo "‚úÖ ƒê√£ th√™m user $USER"
}

# -----------------------------
# ‚ùå X√≥a user
# -----------------------------
del_user() {
    read -p "Nh·∫≠p username c·∫ßn x√≥a: " USER
    sudo userdel -r $USER 2>/dev/null || echo "‚ö†Ô∏è User kh√¥ng t·ªìn t·∫°i"
    echo "‚úÖ ƒê√£ x√≥a user $USER"
}

# -----------------------------
# üßπ G·ª° to√†n b·ªô proxy
# -----------------------------
remove_proxy() {
    echo "‚ö†Ô∏è X√≥a to√†n b·ªô proxy (Dante + c·∫•u h√¨nh)? (y/n)"
    read -r ans
    if [[ $ans == "y" ]]; then
        sudo systemctl stop danted
        sudo systemctl disable danted
        sudo rm -f /etc/systemd/system/danted.service /etc/danted.conf
        sudo rm -f /usr/local/sbin/sockd
        echo "‚úÖ ƒê√£ g·ª° proxy ho√†n to√†n"
    fi
}

# -----------------------------
# üß≠ Menu qu·∫£n l√Ω
# -----------------------------
menu() {
    while true; do
        echo ""
        echo "====== SOCKS5 Proxy Manager ======"
        echo "1Ô∏è‚É£  C√†i ƒë·∫∑t SOCKS5 Proxy"
        echo "2Ô∏è‚É£  Th√™m user"
        echo "3Ô∏è‚É£  X√≥a user"
        echo "4Ô∏è‚É£  G·ª° to√†n b·ªô proxy"
        echo "0Ô∏è‚É£  Tho√°t"
        read -p "Ch·ªçn: " choice
        case $choice in
            1) install_proxy ;;
            2) add_user ;;
            3) del_user ;;
            4) remove_proxy ;;
            0) exit ;;
            *) echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!" ;;
        esac
    done
}

# Ch·∫°y menu
menu
