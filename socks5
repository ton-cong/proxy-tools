#!/bin/bash

# SOCKS5 Proxy Manager cho Amazon Linux 2023/2
# H·ªó tr·ª£: C√†i ƒë·∫∑t, Th√™m user, X√≥a user, X√≥a ho√†n to√†n
# GitHub: https://github.com/yourusername/socks5-amazonlinux

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

DANTE_CONFIG="/etc/danted.conf"
DANTE_SERVICE="/etc/systemd/system/danted.service"
DANTE_BIN="/usr/local/sbin/sockd"

# H√†m ki·ªÉm tra quy·ªÅn root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Script n√†y c·∫ßn ch·∫°y v·ªõi quy·ªÅn root (sudo)${NC}"
        exit 1
    fi
}

# H√†m l·∫•y IP public
get_public_ip() {
    curl -s ifconfig.me || curl -s icanhazip.com || echo "Unknown"
}

# H√†m l·∫•y interface network
get_network_interface() {
    ip -o -4 route show to default | awk '{print $5}' | head -n1
}

# H√†m c√†i ƒë·∫∑t Dante t·ª´ source
install_dante() {
    echo -e "${YELLOW}ƒêang c√†i ƒë·∫∑t dependencies...${NC}"
    yum install -y gcc make wget tar shadow-utils >/dev/null 2>&1
    
    echo -e "${YELLOW}ƒêang t·∫£i v√† build Dante Server...${NC}"
    cd /tmp
    if [ ! -f "dante-1.4.3.tar.gz" ]; then
        wget -q https://www.inet.no/dante/files/dante-1.4.3.tar.gz
    fi
    
    tar xzf dante-1.4.3.tar.gz >/dev/null 2>&1
    cd dante-1.4.3
    
    ./configure >/dev/null 2>&1
    make >/dev/null 2>&1
    make install >/dev/null 2>&1
    
    cd /tmp
    rm -rf dante-1.4.3*
    
    echo -e "${GREEN}‚úì Dante Server ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t${NC}"
}

# H√†m t·∫°o c·∫•u h√¨nh Dante
create_dante_config() {
    local port=$1
    local interface=$(get_network_interface)
    
    cat > $DANTE_CONFIG <<EOF
logoutput: /var/log/danted.log
internal: 0.0.0.0 port = $port
external: $interface

method: username
user.notprivileged: nobody

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect
}

pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    protocol: tcp udp
    method: username
    log: connect disconnect
}
EOF
    
    echo -e "${GREEN}‚úì ƒê√£ t·∫°o file c·∫•u h√¨nh${NC}"
}

# H√†m t·∫°o systemd service
create_systemd_service() {
    cat > $DANTE_SERVICE <<EOF
[Unit]
Description=Dante SOCKS5 Server
After=network.target

[Service]
ExecStart=$DANTE_BIN -f $DANTE_CONFIG
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable danted >/dev/null 2>&1
    echo -e "${GREEN}‚úì ƒê√£ t·∫°o systemd service${NC}"
}

# H√†m c√†i ƒë·∫∑t SOCKS5
install_socks5() {
    echo -e "${GREEN}=== C√ÄI ƒê·∫∂T SOCKS5 PROXY ===${NC}\n"
    
    # Nh·∫≠p th√¥ng tin
    read -p "Nh·∫≠p PORT (m·∫∑c ƒë·ªãnh 1080): " port
    port=${port:-1080}
    
    read -p "Nh·∫≠p USERNAME: " username
    while [ -z "$username" ]; do
        echo -e "${RED}Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!${NC}"
        read -p "Nh·∫≠p USERNAME: " username
    done
    
    read -sp "Nh·∫≠p PASSWORD: " password
    echo
    while [ -z "$password" ]; do
        echo -e "${RED}Password kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!${NC}"
        read -sp "Nh·∫≠p PASSWORD: " password
        echo
    done
    
    # C√†i ƒë·∫∑t Dante n·∫øu ch∆∞a c√≥
    if [ ! -f "$DANTE_BIN" ]; then
        install_dante
    fi
    
    # T·∫°o user
    useradd -M -s /sbin/nologin $username 2>/dev/null || true
    echo "$username:$password" | chpasswd
    echo -e "${GREEN}‚úì ƒê√£ t·∫°o user: $username${NC}"
    
    # T·∫°o c·∫•u h√¨nh
    create_dante_config $port
    
    # T·∫°o service
    create_systemd_service
    
    # Kh·ªüi ƒë·ªông d·ªãch v·ª•
    systemctl restart danted
    sleep 2
    
    # Hi·ªÉn th·ªã th√¥ng tin
    local ip=$(get_public_ip)
    
    echo -e "\n${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë   SOCKS5 PROXY ƒê√É C√ÄI ƒê·∫∂T TH√ÄNH C√îNG  ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
    echo -e "üîå ${YELLOW}IP:${NC}       $ip"
    echo -e "üîê ${YELLOW}Port:${NC}     $port"
    echo -e "üë§ ${YELLOW}Username:${NC} $username"
    echo -e "üîë ${YELLOW}Password:${NC} $password"
    echo -e "\n${GREEN}C√∫ ph√°p s·ª≠ d·ª•ng:${NC}"
    echo -e "socks5://$username:$password@$ip:$port"
    echo -e "\n${GREEN}Test proxy:${NC}"
    echo -e "curl -x socks5h://$username:$password@$ip:$port https://ifconfig.me\n"
}

# H√†m th√™m user m·ªõi
add_user() {
    echo -e "${GREEN}=== TH√äM USER M·ªöI ===${NC}\n"
    
    if [ ! -f "$DANTE_BIN" ]; then
        echo -e "${RED}SOCKS5 ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t! Vui l√≤ng c√†i ƒë·∫∑t tr∆∞·ªõc.${NC}"
        exit 1
    fi
    
    read -p "Nh·∫≠p USERNAME m·ªõi: " username
    while [ -z "$username" ]; do
        echo -e "${RED}Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!${NC}"
        read -p "Nh·∫≠p USERNAME m·ªõi: " username
    done
    
    # Ki·ªÉm tra user ƒë√£ t·ªìn t·∫°i
    if id "$username" &>/dev/null; then
        echo -e "${YELLOW}User $username ƒë√£ t·ªìn t·∫°i!${NC}"
        read -p "B·∫°n c√≥ mu·ªën ƒë·ªïi m·∫≠t kh·∫©u? (y/n): " change_pass
        if [ "$change_pass" != "y" ]; then
            return
        fi
    fi
    
    read -sp "Nh·∫≠p PASSWORD: " password
    echo
    while [ -z "$password" ]; do
        echo -e "${RED}Password kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!${NC}"
        read -sp "Nh·∫≠p PASSWORD: " password
        echo
    done
    
    # T·∫°o ho·∫∑c c·∫≠p nh·∫≠t user
    useradd -M -s /sbin/nologin $username 2>/dev/null || true
    echo "$username:$password" | chpasswd
    
    # L·∫•y th√¥ng tin
    local ip=$(get_public_ip)
    local port=$(grep "port =" $DANTE_CONFIG | awk '{print $4}')
    
    systemctl restart danted
    
    echo -e "\n${GREEN}‚úì User ƒë√£ ƒë∆∞·ª£c th√™m/c·∫≠p nh·∫≠t th√†nh c√¥ng!${NC}\n"
    echo -e "üîå ${YELLOW}IP:${NC}       $ip"
    echo -e "üîê ${YELLOW}Port:${NC}     $port"
    echo -e "üë§ ${YELLOW}Username:${NC} $username"
    echo -e "üîë ${YELLOW}Password:${NC} $password"
    echo -e "\n${GREEN}C√∫ ph√°p:${NC} socks5://$username:$password@$ip:$port\n"
}

# H√†m li·ªát k√™ users
list_users() {
    echo -e "${GREEN}=== DANH S√ÅCH USERS ===${NC}\n"
    
    if [ ! -f "$DANTE_CONFIG" ]; then
        echo -e "${RED}SOCKS5 ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!${NC}"
        return
    fi
    
    local ip=$(get_public_ip)
    local port=$(grep "port =" $DANTE_CONFIG 2>/dev/null | awk '{print $4}')
    
    echo -e "${YELLOW}Server:${NC} $ip:$port\n"
    echo -e "${YELLOW}Users (c√≥ th·ªÉ d√πng cho SOCKS5):${NC}"
    
    # L·∫•y danh s√°ch users c√≥ shell /sbin/nologin (users cho proxy)
    awk -F: '$7 == "/sbin/nologin" {print "  ‚Ä¢ " $1}' /etc/passwd
    echo
}

# H√†m x√≥a user
delete_user() {
    echo -e "${GREEN}=== X√ìA USER ===${NC}\n"
    
    list_users
    
    read -p "Nh·∫≠p username c·∫ßn x√≥a: " username
    
    if [ -z "$username" ]; then
        echo -e "${RED}Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!${NC}"
        return
    fi
    
    if ! id "$username" &>/dev/null; then
        echo -e "${RED}User $username kh√¥ng t·ªìn t·∫°i!${NC}"
        return
    fi
    
    read -p "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user $username? (y/n): " confirm
    if [ "$confirm" = "y" ]; then
        userdel $username 2>/dev/null
        echo -e "${GREEN}‚úì ƒê√£ x√≥a user: $username${NC}"
        systemctl restart danted
    else
        echo -e "${YELLOW}H·ªßy b·ªè thao t√°c${NC}"
    fi
}

# H√†m x√≥a ho√†n to√†n SOCKS5
uninstall_socks5() {
    echo -e "${RED}=== X√ìA HO√ÄN TO√ÄN SOCKS5 ===${NC}\n"
    
    read -p "‚ö†Ô∏è  B·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën x√≥a to√†n b·ªô SOCKS5? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        echo -e "${YELLOW}H·ªßy b·ªè thao t√°c${NC}"
        return
    fi
    
    echo -e "${YELLOW}ƒêang x√≥a...${NC}"
    
    # D·ª´ng service
    systemctl stop danted 2>/dev/null
    systemctl disable danted 2>/dev/null
    
    # X√≥a files
    rm -f $DANTE_SERVICE
    rm -f $DANTE_CONFIG
    rm -f /var/log/danted.log
    rm -f $DANTE_BIN
    rm -rf /usr/local/sbin/sockd
    rm -rf /usr/local/lib/libdsocks*
    
    # X√≥a users proxy (c√≥ shell /sbin/nologin)
    awk -F: '$7 == "/sbin/nologin" {print $1}' /etc/passwd | while read user; do
        userdel $user 2>/dev/null
    done
    
    systemctl daemon-reload
    
    echo -e "${GREEN}‚úì ƒê√£ x√≥a ho√†n to√†n SOCKS5 Proxy${NC}\n"
}

# H√†m hi·ªÉn th·ªã tr·∫°ng th√°i
show_status() {
    echo -e "${GREEN}=== TR·∫†NG TH√ÅI SOCKS5 ===${NC}\n"
    
    if [ ! -f "$DANTE_BIN" ]; then
        echo -e "${RED}SOCKS5 ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!${NC}"
        return
    fi
    
    local ip=$(get_public_ip)
    local port=$(grep "port =" $DANTE_CONFIG 2>/dev/null | awk '{print $4}')
    
    echo -e "üîå ${YELLOW}IP:${NC}   $ip"
    echo -e "üîê ${YELLOW}Port:${NC} $port\n"
    
    if systemctl is-active --quiet danted; then
        echo -e "üìä ${GREEN}Service: RUNNING ‚úì${NC}"
    else
        echo -e "üìä ${RED}Service: STOPPED ‚úó${NC}"
    fi
    
    echo -e "\n${YELLOW}S·ªë l∆∞·ª£ng users:${NC}"
    awk -F: '$7 == "/sbin/nologin" {print "  ‚Ä¢ " $1}' /etc/passwd
    
    echo -e "\n${YELLOW}Ki·ªÉm tra port:${NC}"
    if netstat -tuln 2>/dev/null | grep -q ":$port "; then
        echo -e "  ${GREEN}‚úì Port $port ƒëang m·ªü${NC}"
    else
        echo -e "  ${RED}‚úó Port $port kh√¥ng m·ªü${NC}"
    fi
    echo
}

# Menu ch√≠nh
show_menu() {
    clear
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë     SOCKS5 PROXY - AMAZON LINUX       ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
    echo "1. C√†i ƒë·∫∑t SOCKS5 Proxy"
    echo "2. Th√™m user m·ªõi"
    echo "3. Li·ªát k√™ users"
    echo "4. X√≥a user"
    echo "5. Xem tr·∫°ng th√°i"
    echo "6. X√≥a ho√†n to√†n SOCKS5"
    echo "0. Tho√°t"
    echo -e "\n${YELLOW}Ch·ªçn ch·ª©c nƒÉng [0-6]:${NC} "
}

# H√†m c√†i ƒë·∫∑t l·∫ßn ƒë·∫ßu (kh√¥ng menu)
first_install() {
    echo -e "${GREEN}=== C√ÄI ƒê·∫∂T SOCKS5 PROXY L·∫¶N ƒê·∫¶U ===${NC}\n"
    
    # Nh·∫≠p PORT
    read -p "Nh·∫≠p PORT (m·∫∑c ƒë·ªãnh 1080): " port
    port=${port:-1080}
    
    # Nh·∫≠p USERNAME
    read -p "Nh·∫≠p USERNAME: " username
    while [ -z "$username" ]; do
        echo -e "${RED}Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!${NC}"
        read -p "Nh·∫≠p USERNAME: " username
    done
    
    # Nh·∫≠p PASSWORD
    read -sp "Nh·∫≠p PASSWORD: " password
    echo
    while [ -z "$password" ]; do
        echo -e "${RED}Password kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!${NC}"
        read -sp "Nh·∫≠p PASSWORD: " password
        echo
    done
    
    # C√†i ƒë·∫∑t Dante
    install_dante
    
    # T·∫°o user
    useradd -M -s /sbin/nologin $username 2>/dev/null || true
    echo "$username:$password" | chpasswd
    echo -e "${GREEN}‚úì ƒê√£ t·∫°o user: $username${NC}"
    
    # T·∫°o c·∫•u h√¨nh
    create_dante_config $port
    
    # T·∫°o service
    create_systemd_service
    
    # Kh·ªüi ƒë·ªông d·ªãch v·ª•
    systemctl restart danted
    sleep 2
    
    # Hi·ªÉn th·ªã th√¥ng tin
    local ip=$(get_public_ip)
    
    echo -e "\n${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë   SOCKS5 PROXY ƒê√É C√ÄI ƒê·∫∂T TH√ÄNH C√îNG  ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
    echo -e "üîå ${YELLOW}IP:${NC}       $ip"
    echo -e "üîê ${YELLOW}Port:${NC}     $port"
    echo -e "üë§ ${YELLOW}Username:${NC} $username"
    echo -e "üîë ${YELLOW}Password:${NC} $password"
    echo -e "\n${GREEN}C√∫ ph√°p s·ª≠ d·ª•ng:${NC}"
    echo -e "socks5://$username:$password@$ip:$port"
    echo -e "\n${GREEN}Test proxy:${NC}"
    echo -e "curl -x socks5h://$username:$password@$ip:$port https://ifconfig.me\n"
    
    exit 0
}

# H√†m main
main() {
    check_root
    
    # Ki·ªÉm tra xem ƒë√£ c√†i SOCKS5 ch∆∞a
    if [ ! -f "$DANTE_BIN" ]; then
        # Ch∆∞a c√†i - Ki·ªÉm tra xem c√≥ input t·ª± ƒë·ªông kh√¥ng
        if [ -p /dev/stdin ]; then
            read -t 0.1 port username password 2>/dev/null || true
            if [ -n "$port" ] && [ -n "$username" ] && [ -n "$password" ]; then
                # C√†i ƒë·∫∑t t·ª± ƒë·ªông
                install_dante
                
                useradd -M -s /sbin/nologin $username 2>/dev/null || true
                echo "$username:$password" | chpasswd
                
                create_dante_config $port
                create_systemd_service
                systemctl restart danted
                
                local ip=$(get_public_ip)
                echo -e "\n${GREEN}‚úì SOCKS5 ƒë√£ c√†i ƒë·∫∑t: socks5://$username:$password@$ip:$port${NC}\n"
                exit 0
            fi
        fi
        
        # C√†i ƒë·∫∑t l·∫ßn ƒë·∫ßu v·ªõi input th·ªß c√¥ng
        first_install
    else
        # ƒê√£ c√†i r·ªìi - Hi·ªÉn th·ªã menu
        while true; do
            show_menu
            read -r choice
            
            case $choice in
                1) install_socks5 ;;
                2) add_user ;;
                3) list_users ;;
                4) delete_user ;;
                5) show_status ;;
                6) uninstall_socks5 ;;
                0) echo -e "${GREEN}T·∫°m bi·ªát!${NC}"; exit 0 ;;
                *) echo -e "${RED}L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!${NC}" ;;
            esac
            
            echo -e "\n${YELLOW}Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c...${NC}"
            read
        done
    fi
}

# Ch·∫°y script
main
